"use strict";$(function(){var b=$.rib.fsUtils,c={_projectsInfo:{},_lastPid:0,_activeProject:null,designDirty:false,pInfoDirty:false,allTags:[],ProjectDir:"/projects",thumbDir:"/thumb-css/",thumbPrefix:"svg.thumbnail",pidPrefix:"p",relativeFilter:{type:"url-uploadable",value:/^(?!((https?|ftp):|src)\/+).+/i},resourceRef:{},propertySchema:{name:{type:"string",defaultValue:"Untitled"},accessDate:{type:"number",defaultValue:""},device:{type:"object",defaultValue:{name:"Phones",screenWidth:320,screenHeight:480}},thumbnail:{type:"string",defaultValue:""},theme:{type:"string",defaultValue:"Default"},},themesList:{},allThemes:[]};c.init=function(n,m){var h,o,f,j=0,p=[],l=[];f=function(){var q;q=p.length+l.length;if(q===j){$.rib.pmUtils.showLastOpened(n,m)}};h=function(q){j=q.length;if(j===0){f();return}$.each(q,function(t,u){var s,r;r=u.name;s=r.substr(c.pidPrefix.length);s=parseInt(s);if(c._lastPid<s){c._lastPid=s}});$.each(q,function(r,s){b.read(s.fullPath+"/pInfo.json",function(u){var t=$.parseJSON(u);c._projectsInfo[s.name]=t;l.push(s.name);f()},function(){p.push(s.name);f();console.error("Can't get design file for project:",s.name);if(s.isDirectory){s.removeRecursively(function(){console.warn("Broken project removed:",s.name)})}})});return};o=function(q){if(q.code===FileError.NOT_FOUND_ERR){b.mkdir(c.ProjectDir,f,m)}else{console.error(q.code);m&&m()}};b.ls(c.ProjectDir,h,o);e();var k=function(q){var r=encodeURIComponent(q);var s=false;$.ajax({url:"https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20html%20where%20url%3D%22"+r+"%22&format=json",type:"get",async:false,dataType:"json",success:function(t){s=t.query.results!=null},error:function(){s=false}});return s};var i=$.rib.fsUtils.fs.root.toURL()+"themes.json";if(k(i)){$.ajax({type:"GET",url:i,dataType:"json",success:function(q){$.extend(true,c.themesList,q)},error:function(q){},async:false})}var g=function(q){c.allThemes.length=0;$.each(q,function(r,s){c.allThemes.push(s.name)})};$.rib.fsUtils.ls("/themes/",g,null)};c.getActive=function(){return c._activeProject};c.getProjectDir=function(f){f=f||c._activeProject;if(!f){return null}else{return c.ProjectDir+"/"+f+"/"}};c.getProperties=function(f){var g;f&&(g=c._projectsInfo[f]);if(!(f&&g)){console.error("Invalid pid in getProperties, pid:"+f);return null}return $.extend(true,{},g)};c.getPropertySchema=function(g){var f=c.propertySchema[g];if(typeof f!="object"){throw new Error("Undefined schema for property:"+g)}else{return $.extend(true,{},f)}};c.getPropertyDefault=function(g){var f=c.getPropertySchema(g);if(f){if(g==="accessDate"){return(new Date())}return f.defaultValue}return f};c.getProperty=function(f,j){var h,g,i;g=c.getProperties(f);if(g.hasOwnProperty(j)){i=g[j]}else{i=c.getPropertyDefault(j)}if(j==="accessDate"){return(new Date(i))}return i};c.setProperty=function(g,k,j){var i,h,f;g&&(h=c._projectsInfo[g]);if(!(g&&h)){console.error("Invalid pid in setProperty, pid:"+g);return null}i=c.getPropertySchema(k);if(k==="accessDate"){j=(new Date(j)).getTime()}if(!(h&&i.type)){console.error("Error: Invalid pid: "+g+" or property: "+k+" in pmUtils.setProperty");return false}if(typeof j!==i.type){console.error("Error: attempted to set property "+k+" ("+i.type+") with wrong type ("+typeof j+")");return false}if(h[k]!==j){f=new Object();f[k]=j;$.extend(true,h,f);c.pInfoDirty=true}return true};c.setProperties=function(l,n){var k,r,s,m,q,o,g,j="src/css/jquery.mobile.theme-1.1.0.css",f=ADM.getDesignRoot();var h=function(i){var p;if(jQuery.inArray(i+".min.css",$.rib.pmUtils.allThemes)!==-1){p="/themes/"+i+".min.css"}else{p="/themes/"+i+".css"}return p};l&&(r=c._projectsInfo[l]);if(!(l&&r)||typeof n!=="object"){console.error("Invalid project or properties in setProperties");return false}for(k in n){if(c.propertySchema.hasOwnProperty(k)){if(k==="theme"&&c.getProperty(l,"theme")!==n[k]){m=n[k];q=c.getProperty(l,"theme");if(m==="Default"){$.rib.setDesignTheme(f,j,false)}else{m=h(m);$.rib.setDesignTheme(f,m,true)}}c.setProperty(l,k,n[k])}else{s=new Object();s[k]=n[k];$.extend(true,r,s);c.pInfoDirty||(c.pInfoDirty=true)}}return true};c.showLastOpened=function(j,g){var f,h,i;i=null;h=$.rib.pmUtils._projectsInfo;for(f in h){if(h.hasOwnProperty(f)){if(!i||h[f].accessDate>h[i].accessDate){i=f}}}if(i){$.rib.pmUtils.openProject(i,j,g)}else{$.rib.pmUtils.createProject({name:"Untitled"},function(){j&&j()})}};c.syncCurrentProject=function(i,g){var h,f;h=c._activeProject;f=ADM.getDesignRoot();if(h){c.syncProject(h,f,i,g)}else{i&&i()}};c.createProject=function(j,m,i,h){var k,g,l,f;k=c.getValidPid();l=function(){var o,p,n;o=new ADMNode("Design");n={pageTemplate:"JQuery Mobile Page",pageTitle:"Home",layout:["Header","Footer"]};n.design=o;p=$.rib.pageUtils.createNewPage(n);if(!p){console.log("Warning: create new page failed")}return o};g=function(n){c.syncCurrentProject(function(){c._activeProject=k;c._projectsInfo[k]={};c.setProperties(k,j);c.setProperty(k,"accessDate",new Date());$.rib.pmUtils.resourceRef={};if(h&&(h instanceof ADMNode)){ADM.setDesignRoot(h)}else{ADM.setDesignRoot(l())}c.designDirty=true;m&&m(k);c.syncProject(k,ADM.getDesignRoot())})};f=function(n){if(n.code===FileError.QUOTA_EXCEEDED_ERR){}else{console.error(n.code)}i&&i(n)};b.mkdir((c.ProjectDir+"/"+k),g,f)};c.getDesignPath=function(f){var g=c.ProjectDir+"/"+f+"/design.json";return g};c.getMetadataPath=function(f){var g=c.ProjectDir+"/"+f+"/pInfo.json";return g};c.cloneProject=function(h,i,f){var j=c.ProjectDir+"/",g=c.getValidPid();b.cp(j+h,j+g,function(k){c._projectsInfo[g]={};c.setProperties(g,c._projectsInfo[h]);c.setProperty(g,"accessDate",new Date());c.syncProject(g,null,i,f)},f)};c.getValidPid=function(){var f;f=++c._lastPid;return c.pidPrefix+f};c.openProject=function(g,k,i){var j,h,f;if(!c._projectsInfo[g]){console.error("Error: Invalid pid for project when opening project");return}if(c._activeProject===g){k&&k();return}j=c.getDesignPath(g);f=c.getProjectDir(g)+"images/";h=function(l){var m,n;n=$.rib.JSONToProj(l);m=n.design;if(m&&(m instanceof ADMNode)){c._activeProject=g;c.setProperty(g,"accessDate",new Date());$.rib.pmUtils.resourceRef={};$.rib.fsUtils.ls(f,function(o){$.each(o,function(p,q){$.rib.pmUtils.resourceRef["images/"+q.name]=0})},function(o){dumplog("There is no image in this project.")});ADM.setDesignRoot(m);k&&k()}else{i&&i()}};c.syncCurrentProject(function(){$.rib.fsUtils.read(j,h)});return};c.deleteProject=function(g,j,i){var f=c.ProjectDir+"/"+g,h=function(){delete c._projectsInfo[g];if(c._activeProject===g){c._activeProject=null}j&&j(g)};b.rm(f,h,i,true)};c.exportProject=function(){var g,i,h,k,f;g=c.getActive();i=c._projectsInfo[g];if(!i){console.error("Error: Invalid pid for project")}h=ADM.getDesignRoot();k=$.rib.ADMToJSONObj(h);if(typeof k==="object"){k.pInfo=$.extend(true,{},i);delete k.pInfo.thumbnail;f=JSON.stringify(k);try{$.rib.exportPackage(f)}catch(j){console.error("Export to package failed");return false}}else{console.error("Invalid serialized Object for ADM tree");return false}return true};c.updateThumbnail=function(h){var i,g,f;f=$.rib.pmUtils.getActive();if(!f){dumplog("Warning: No active project to update thumbnail.");return false}i=$(h.documentElement).clone();$("body",i).children(":not(.ui-page-active)").remove();$("head",i).remove();g=i[0].outerHTML;g=g.replace(/<(html|body)/ig,"<div");g=g.replace(/(html|body)>/ig,"div>");if(i.length&&g&&g.length){$.rib.pmUtils.setProperty(f,"thumbnail",g)}};function e(){var f,l,g,j,k;g=ADM.getDesignRoot();l=g.getPropertyDefault("css");for(j=0;j<l.length;j++){k=l[j];if(k.designOnly){continue}d(k.value)}return}function d(g){var f=$.rib.pmUtils.toThumbCssPath(g);$.rib.fsUtils.pathToEntry(f,null,function(h){if(h.code===FileError.NOT_FOUND_ERR){$.ajax({type:"GET",url:g,dataType:"text",success:function(j){var i=$.rib.pmUtils.toLimitedCss(j);if(i){$.rib.fsUtils.write(f,i)}},async:false})}else{$.rib.fsUtils.onError(h)}})}c.toLimitedCss=function(i,g){var j,k,f,h;g=g||$.rib.pmUtils.thumbPrefix;if((typeof i!=="string")||(typeof g!=="string")){console.warn("Wrong parameter type when getting limited css.");return null}f="";h=["from","to"];j=/\/\*(\r|\n|.)*?\*\//g;i=i.replace(j,"");k=i.split("}");$.each(k,function(p,t){var l,n,r,o,p,m;n=t.indexOf("{");if(n<0){return}l=$.trim(t.substr(0,n));r=$.trim(t.substr(n+1,t.length));if(r.length<1||l.length<1){return}m=[];o=l.split(",");for(p=0;p<o.length;p++){var q=$.trim(o[p]);if(q.length<1){continue}if(q[0]==="@"){r=$.rib.pmUtils.toLimitedCss(r,g)}if(h.indexOf(q)===-1){q=g+" "+q}m.push(q)}if(m.length>0){f+=m.join(",")+"{"+r+"}"}});return f};c.toThumbCssPath=function(f){var h,g,j,i;if(f instanceof Object){h=f.value}else{h=f}if(typeof h!=="string"){console.warn("Wrong parameter type when get thumb css Path.");return null}g=h.lastIndexOf("/");j=h.substr(g+1,h.length);return c.thumbDir+j};c.importProject=function(h,i,g){var f=new FileReader();f.onloadend=function(q){var s,l,t,j,n,r,o,k,p,m;o=q.target.result;j=/\.(json|rib)$/i;n=/^images\//i;r=[];try{k=new ZipFile(o)}catch(q){console.warn("Failed to parse imported file as zip.")}if(k&&k.filelist){k.filelist.forEach(function(v,u,w){if(j.test(v.filename)){t=k.extract(v.filename)}if(n.test(v.filename)){r.push(v.filename)}})}else{console.warn("Try to parse imported file as JSON.");t=o}m=$.rib.JSONToProj(t);if(!m){alert("Invalid imported project.");return}s=m.pInfo||{name:"Imported Project"};l=m.design;p=function(v){var w,x,u;u=$.rib.pmUtils.ProjectDir+"/"+v+"/";if(r.length<=0){i&&i();return}x=0;w=function(y){if(!y.isDirectory){console.error(y.fullPath+" is not a directory to save files in sandbox.");return}$.each(r,function(z,A){$.rib.fsUtils.write(u+A,k.extract(A),function(B){x++;if(x===r.length){i&&i()}},function(B){x++;console.error("Error when copy "+u+A+" to sandbox.");$.rib.fsUtils.onError(B)},false,true)})};$.rib.fsUtils.mkdir(u+"images",w,function(y){console.error("Failed to create sub-folder images/ in "+u)})};if(l&&(l instanceof ADMNode)){$.rib.pmUtils.createProject(s,p,g,l)}else{console.error("Imported project failed");g&&g()}};f.onError=function(){console.error("Read imported file error.")};f.readAsBinaryString(h)};c.syncProject=function(j,f,o,m){var n,k,i,g,l,h;if(j&&(j!==c._activeProject)){g=true}j=j||c._activeProject;f=f||ADM.getDesignRoot();l=g||c.designDirty;h=g||c.pInfoDirty;if(!(l||h)){o&&o();return}i=function(t,r,u,q){var s,p;if(!r||!t){console.warn("No data or path to save write");return}s=t+".swap";p=function(v){v.getParent(function(x){var w=v.name;w=w.slice(0,(w.length-5));v.moveTo(x,w,u,q)})};$.rib.fsUtils.write(s,r,p,q)};n=function(p,s,r,q){var t,u,v;t=c.getDesignPath(p);v=$.rib.ADMToJSONObj(s);if(typeof v==="object"){u=JSON.stringify(v);i(t,u,r,q)}else{console.error("sync failed: invalid serialized Object for ADM tree")}return};k=function(p,w,r){var t,s,q,u;if(!h){w&&w();return}t=c._projectsInfo[p];s=c.getMetadataPath(p);q=function(){(!g)&&(c.pInfoDirty=false);w&&w()};try{u=JSON.stringify(t)}catch(v){console.error("Failed to stringify pInfo, "+v);r&&r(v);return}i(s,u,q,r)};if(l){n(j,f,function(){(!g)&&(c.designDirty=false);k(j,o,m)},m)}else{k(j,o,m)}};c.getProjectByTag=function(g){var f=$.map(c._projectsInfo,function(i,h){if($.inArray(g.toString(),i.tags)!==-1){return{pid:h,date:i.accessDate}}});c.sortByAccessDate(f)};c.listAllProject=function(){var f=$.map(c._projectsInfo,function(h,g){return{pid:g,date:h.accessDate}});c.sortByAccessDate(f);return f};c.sortByAccessDate=function(f){var g=function(i,h){return(h.date-i.date)};return f.sort(g)};c.addRefCount=function(f){if(!c.resourceRef[f]){c.resourceRef[f]=1}else{c.resourceRef[f]++}$.rib.fireEvent("imagesUpdated",{usageStatus:c.resourceRef});return};c.reduceRefCount=function(g){var f=c.ProjectDir+"/"+c.getActive()+"/";if(c.resourceRef.hasOwnProperty(g)){c.resourceRef[g]--;if(c.resourceRef[g]<=0){delete c.resourceRef[g];$.rib.fsUtils.pathToEntry(f+g,function(h){$.rib.confirm('Unused resource: "'+h.name+'". \nWould you like to delete it from the project?',function(){$.rib.fsUtils.rm(h.fullPath);$.rib.fireEvent("imagesUpdated",{usageStatus:c.resourceRef})},function(){c.resourceRef[g]=0;$.rib.fireEvent("imagesUpdated",{usageStatus:c.resourceRef})})})}}else{console.warn("No reference count for "+g+"in reduceRefCount")}return};c.scanADMNodeResource=function(j,h){var f,g,l,k;j=j||ADM.getDesignRoot();if(!(j instanceof ADMNode)){return false}f=j.findNodesByProperty($.rib.pmUtils.relativeFilter);for(g=0;g<f.length;g++){if(!f[g].properties){continue}for(l in f[g].properties){k=f[g].properties[l];h?$.rib.pmUtils.addRefCount(k):$.rib.pmUtils.reduceRefCount(k)}}return true};c.usedResources=function(){return $.extend(true,{},c.resourceRef)};c.uploadTheme=function(j,h){var g,f;var i=function(m){var l,k=/(?:.*)+\.(zip|css)$/i;l=k.exec(m);if(l){return l[1].toLowerCase()}else{return"unsupported"}};g=i(j.name);switch(g){case"css":a(j.name,j,h);break;case"zip":f=new FileReader();f.onloadend=function(p){var n,o,m,l,k=[];o=p.target.result;m=/(\.min\.css)$/i;try{n=new ZipFile(o)}catch(p){console.warn("Failed to parse imported file as zip.")}if(n&&n.filelist){n.filelist.forEach(function(r,q,s){if(m.test(r.filename)){l=n.extract(r.filename);a(r.filename.replace(/^themes\//i,""),l,h)}})}};f.onError=function(){console.error("Read imported file error.")};f.readAsBinaryString(j);break;case"default":console.warn("unsupported file type, please upload css or zip file");break}};c.getAllThemes=function(){var f=["Default"];for(var g in c.themesList){f.push(g)}return f};function a(j,h,g){var m=function(o){var p=[],s,n=[],q,r=/\.ui-bar-[a-z]/g;n=o.match(r);for(q=0;q<n.length;q++){s=n[q].replace(/\.ui-bar-/g,"");if(s&&jQuery.inArray(s,p)===-1){p.push(s)}}return p};var f=function(r,q,p){if(q instanceof Blob){var n=new FileReader();n.onloadend=function(s){o(s.target.result)};n.onError=function(){console.error("Read imported file error.")};n.readAsBinaryString(q)}else{o(q)}function o(s){var x,t=[],u,v;if(typeof s!=="string"){console.error("Wrong parameter type in pareseCssBuffer.");return}try{x=r.replace(/(\.min.css|\.css)$/g,"");t=m(s);if(t.length){$.rib.fsUtils.write("/themes/"+r,s,function(y){$.rib.pmUtils.allThemes.push(r);c.themesList[x]=t;c.themesList[x].unshift("default");$.rib.fsUtils.write("/themes.json",JSON.stringify(c.themesList));u=$.rib.pmUtils.toThumbCssPath(y.name);v=$.rib.pmUtils.toLimitedCss(s);if(v){$.rib.fsUtils.write(u,v)}p()})}}catch(w){console.log("Error writing theme file:",w.stack)}return}};var l,i=/(\.min\.css)$/i,k=j.replace(/(\.css|\.min.css)$/g,"");if($.rib.pmUtils.themesList.hasOwnProperty(k)||k==="Default"){if(k==="Default"){l="The name Default is reserved for the jQuery Mobile  default theme (jquery.mobile.theme-1.1.0.css). Please  rename imported theme.";$.rib.msgbox(l,{OK:null});return}else{l="The theme "+k+" already exists. Would you like to replace it?";$.rib.confirm(l,function(){var n,o;var o=function(){var r,u,q=ADM.getDesignRoot(),s,p,t;u=$.merge([],q.getProperty("css"));for(s=0;s<u.length;s++){if(u[s].hasOwnProperty("theme")){r=u[s].value;break}}p=r.replace(/^\//,"").split("/");t=p.splice(p.length-1,1).toString();t=t.replace(/(\.min.css|\.css)$/g,"");if(t===j.replace(/(\.min.css|\.css)$/g,"")){$.rib.setDesignTheme(q,"/themes/"+j,true);g()}else{g()}};if(i.test(j)){n=j.replace(/\.min\.css$/g,".css")}else{n=j.replace(/\.css$/g,".min.css")}if(jQuery.inArray(n,c.allThemes)!==-1){$.rib.fsUtils.rm("/themes/"+n,function(){var p,q=$.rib.pmUtils.allThemes;p=q.indexOf(n);if(p!=-1){q.splice(p,1)}f(j,h,o)})}else{f(j,h,o)}})}}else{f(j,h,g)}}$.rib.pmUtils=c});