"use strict";window.BlobBuilder=window.BlobBuilder||window.MozBlobBuilder||window.WebKitBlobBuilder;window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem;window.resolveLocalFileSystemURL=window.resolveLocalFileSystemURL||window.webkitResolveLocalFileSystemURL;window.storageInfo=navigator.webkitPersistentStorage;$(function(){var b={defaultTarget:"export-target",fsType:window.PERSISTENT,fsSize:20*1024*1024,fs:null,db:null,deferredOperations:[],fileTypes:{js:{mime:"text/javascript",suffix:["js"]},image:{mime:"image/*",suffix:["jpg","png","svg","bmp","gif","jpeg","jpm","jp2","jpx","xml","cgm","ief"]},css:{mime:"text/css",suffix:["css"]},zip:{mime:"application/zip",suffix:["zip"]},any:{mime:"*",suffix:["*"]}},initFS:function(f,d,h,c){var g=c||b.onError,e;if(d<=0){console.warn("Required size for filesystem should be a positive number.");return}e=function(j){b.fs=j;if(!$("iframe#"+b.defaultTarget).length){$("<iframe></iframe>").attr("id",b.defaultTarget).css("display","none").appendTo("body")}if(h){h(j)}while(b.deferredOperations.length>0){var i=b.deferredOperations.shift();i.op.apply(this,i.arg)}};if(!requestFileSystem){console.error("Filesystem not available");return}storageInfo.requestQuota(d,function(i){console.log("we were granted ",i,"bytes");if(i<=0){f=window.TEMPORARY;i=d}requestFileSystem(f,i,e,g)},g)},onError:function(c){var d="Error: ";console.log(c.code);switch(c.code){case DOMError.IndexSizeError:d+="The index is not in the allowed range (e.g. thrown in a range object).";break;case DOMError.HierarchyRequestError:d+="The node tree hierarchy is not correct.";break;case DOMError.WrongDocumentError:d+="The object is in the wrong document.";break;case DOMError.InvalidCharacterError:d+="The string contains invalid characters.";break;case DOMError.NoModificationAllowedError:d+="The object can not be modified.";break;case DOMError.NotFoundError:d+="The object can not be found here.";break;case DOMError.NotSupportedError:d+="The operation is not supported";break;case DOMError.InvalidStateError:d+="The object is in an invalid state.";break;case DOMError.SyntaxError:d+="The string did not match the expected pattern.";break;case DOMError.InvalidModificationError:d+="The object can not be modified in this way.";break;case DOMError.NamespaceError:d+="The operation is not allowed by Namespaces in XML";break;case DOMError.InvalidAccessError:d+="The object does not support the operation or argument.";break;case DOMError.TypeMismatchError:d+="The type of the object does not match the expected type.";break;case DOMError.SecurityError:d+="The operation is insecure.";break;case DOMError.NetworkError:d+="A network error occurred.";break;case DOMError.AbortError:d+="The operation was aborted.";break;case DOMError.URLMismatchError:d+="The given URL does not match another URL.";break;case DOMError.QuotaExceededError:d+="The quota has been exceeded.";break;case DOMError.TimeoutError:d+="The operation timed out.";break;case DOMError.InvalidNodeTypeError:d+="The node is incorrect or has an incorrect ancestor for this operation.";break;case DOMError.DataCloneError:d+="The object can not be cloned.";break;default:d+="Unknown Error";break}console.warn(d)},pathToUrl:function(d){if(typeof d!=="string"){console.error("String type is needed for file which is to be read.");return false}var c=b.fs.root.toURL()+d.replace(/^\//,"");return c},pathToEntry:function(f,g,d){var c=b.pathToUrl(f);var e=d||b.onError;resolveLocalFileSystemURL(c,function(h){g&&g(h)},e)},ls:function(f,g,d){var c=f||"/",e=d||b.onError;b.fs.root.getDirectory(c,{},function(i){var h=i.createReader();h.readEntries(function(j){g&&g(j)},e)},e)},touch:function(e,i,d){var c,j,f,h,g;h=d||b.onError;if(typeof e!=="string"||e[e.length-1]==="/"){console.error('Invalid file path: "'+e+'" when touch file.');d&&d();return}g=function(k,l){k.getFile(l,{create:true,exclusive:true},function(m){dumplog(m.fullPath+" is created.");if(i){i(m)}},h)};c=e.lastIndexOf("/");if(c>0){j=e.substr(c+1,e.length);f=e.substr(0,c+1);b.mkdir(f,function(k){g(k,j)},h)}else{g(b.fs.root,e)}},read:function(e,f,c){var d=c||b.onError;b.pathToEntry(e,function(g){g.file(function(i){var h=new FileReader();h.onloadend=function(j){f(j.target.result)};h.onError=d;h.readAsText(i)},d)},d)},write:function(h,f,i,c,g,j){var e=c||b.onError;function d(k){k.createWriter(function(p){var q,n,l;p.onwriteend=function(r){i&&i(k)};p.onerror=e;if(g){p.seek(p.length)}if(f instanceof Blob){p.write(f)}else{if(j){n=new ArrayBuffer(f.length);l=new Uint8Array(n);for(var m=0;m<f.length;m++){l[m]=f.charCodeAt(m)}f=l}try{q=new Blob([f])}catch(o){if(window.BlobBuilder){q=new BlobBuilder();q.append(f);q=q.getBlob()}else{console.error("No Blob or BlobBuilder constructor.");return}}q&&p.write(q)}},e)}b.pathToEntry(h,function(k){if(g){d(k)}else{b.rm(h,function(){b.touch(h,d,c)},e)}},function(k){if(k.code===FileError.NOT_FOUND_ERR){b.touch(h,d,e)}else{e(k)}})},cp:function(i,h,f,c){var d=c||b.onError;var e=h.replace(/^\//,"").split("/"),g=e.splice(e.length-1,1).toString();b.pathToEntry(i,function(j){b.pathToEntry(e.length>0?e.join("/"):"/",function(k){j.copyTo(k,g,function(l){if(f){f(l)}},d)})})},mv:function(i,h,g,d){var e=d||b.onError;var f=h.replace(/^\//,"").split("/"),c=f.splice(f.length-1,1).toString();b.pathToEntry(i,function(j){b.pathToEntry(f.length>0?f.join("/"):"/",function(k){j.moveTo(k,c,function(l){if(g){g(l)}},e)})})},rm:function(f,g,d,c){var e=d||b.onError;b.fs.root[c?"getDirectory":"getFile"](f,{create:false},function(h){h[c?"removeRecursively":"remove"](function(){dumplog(f+" is removed.");if(g){g()}},e)},e)},mkdir:function(e,f,c){var d,g;d=c||b.onError;g=function(h,i){if(i[0]==="."||i[0].length<=0){i=i.slice(1)}h.getDirectory(i[0],{create:true},function(j){if(i.length>1){g(j,i.slice(1))}else{f&&f(j)}},d)};g(b.fs.root,e.split("/"))},exportToBlank:function(h){var f=b.pathToUrl(h),d=false,i,c="height=200, width=500, top=10, left=10, resizable=yes";try{i=window.open(f,"_blank",c);if(!i){d=true}}catch(g){d=true}if(d){alert("Export window was blocked!")}},exportToTarget:function(h,g){var d=b.pathToUrl(h),c=false,i;g=g||b.defaultTarget;try{i=window.open(d,g);if(!i){c=true}}catch(f){c=true}if(c){alert("Export window was blocked!")}},checkFileType:function(d,c){var e,f;if(d==="any"){return true}e=b.fileTypes[d.toLowerCase()].suffix.join("|");f=new RegExp("\\.("+e+")$","i");return f.test(c.name)},upload:function(d,c,h,f){var e,g;c=c||$("body");g=b.fileTypes[d.toLowerCase()].mime;e=$('<input type="file" accept="'+g+'"/>').addClass("hidden-accessible").appendTo(c);e.change(function(j){var i;if(j.currentTarget.files.length===1){i=j.currentTarget.files[0];if(b.checkFileType(d,i)){h&&h(i)}else{console.warn("Unexpected uploaded file.");f&&f()}}else{if(j.currentTarget.files.length<=1){console.warn("No files specified to import")}else{console.warn("Multiple file import not supported")}f&&f()}e.remove()});setTimeout(function(){e.removeClass("hidden-accessible").click();e.addClass("hidden-accessible")},0)}},a={get:function(d){var f,c,g=null,e;if(typeof d!=="string"){console.error("Invalid cookie name.");return g}if(document.cookie&&document.cookie!==""){f=document.cookie.split(";");for(e=0;e<f.length;e++){c=$.trim(f[e]);if(c.substring(0,d.length+1)===(d+"=")){g=decodeURIComponent(c.substring(d.length+1));break}}}else{dumplog("Warning: don't support cookie or empty cookie.")}return g},set:function(d,e,c){var f;if(typeof d!=="string"||typeof e!=="string"){console.error("Invalid cookie name or value.");return false}f=encodeURIComponent(d)+"="+encodeURIComponent(e);if(c instanceof Date){f+="; expires="+c.toGMTString()}document.cookie=f;if(document.cookie&&document.cookie!==""){return true}else{console.warn("Failed to set cookie.");return false}}};$.rib=$.rib||{};$.each(["ls","touch","rm","mkdir","read","write"],function(d,c){var e=b[c];b[c]=function(){if(b.fs===null){b.deferredOperations.push({op:e,arg:arguments});return}else{return e.apply(this,arguments)}}});$.rib.fsUtils=b;$.rib.cookieUtils=a});